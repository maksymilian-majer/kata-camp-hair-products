FROM node:24-bookworm

ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable pnpm

WORKDIR /app

COPY <<'EOF' /entrypoint.sh
#!/bin/sh
# Clean .nx contents to avoid stale lock files from previous runs
rm -rf /app/.nx/* 2>/dev/null || true

pnpm install --frozen-lockfile
exec "$@"
EOF
RUN chmod +x /entrypoint.sh

ENTRYPOINT ["/entrypoint.sh"]
